# EF Core Lab

A .NET 8 Web API project demonstrating Entity Framework Core with SQL Server.

## Project Structure

### Entities (Data/)
- **Customer**: Represents a customer with Name, Email, Invoices, and PhoneNumbers
- **Invoice**: Represents an invoice with InvoiceNumber, CustomerId, InvoiceDate, and Amount
- **TelephoneNumber**: Represents a phone number with CustomerId, Type (Mobile/Work/DirectDial), and Number

**Note:** All entity IDs are auto-generated by the database using identity columns. When creating new records via the API, you do not need to provide an ID - it will be automatically assigned and returned in the response.

### DTOs (DTOs/)
Each entity has three DTO variants:
- **[Entity]Dto**: For read operations (GET) - includes the database-generated ID
- **Create[Entity]Dto**: For create operations (POST) - does not include ID as it's auto-generated
- **Update[Entity]Dto**: For update operations (PUT) - ID is provided in the URL path

### Repositories (Repositories/)
Repository pattern implementation for data access:
- **ICustomerRepository / CustomerRepository**
- **IInvoiceRepository / InvoiceRepository**
- **ITelephoneNumberRepository / TelephoneNumberRepository**

All repository `CreateAsync` methods return the entity with the database-generated ID populated.

### Controllers (Controllers/)
RESTful API controllers:
- **CustomersController**: CRUD operations for customers
- **InvoicesController**: CRUD operations for invoices
- **TelephoneNumbersController**: CRUD operations for telephone numbers

All `POST` endpoints return the created entity with the auto-generated ID in the response body and the location header.

### Mappings (Mappings/)
Extension methods for converting between entities and DTOs.

### Data Generation (Bogus.cs)
Uses the Bogus library to generate realistic fake data for testing and development.

## Database Constraints

### Customer
- **Id**: Auto-generated identity column (BIGINT)
- Email must be unique
- Email max length: 200 characters
- Name max length: 200 characters

### Invoice
- **Id**: Auto-generated identity column (BIGINT)
- InvoiceNumber must be unique and start with "INV"
- InvoiceNumber max length: 50 characters
- Amount must be >= 0 (check constraint)
- Amount stored as decimal(18,2)

### TelephoneNumber
- **Id**: Auto-generated identity column (BIGINT)
- Type must be one of: Mobile, Work, or DirectDial (check constraint)
- Type max length: 20 characters
- Number max length: 50 characters

## Getting Started

### Prerequisites
- .NET 8 SDK
- SQL Server or SQL Server LocalDB

### Configuration

**Important:** Before running the application, you must configure your database connection.

1. **Copy the example configuration:**
   ```powershell
   Copy-Item appsettings.Example.json appsettings.Development.json
   ```

2. **Update your credentials** in `appsettings.Development.json`:
   - Replace `YOUR_USER` with your SQL Server username
   - Replace `YOUR_PASSWORD` with your SQL Server password

3. **See [CONFIGURATION.md](CONFIGURATION.md)** for detailed setup instructions, security best practices, and connection string examples.

### Troubleshooting

If you encounter any issues during setup or while running the application, please refer to:
- **[TROUBLESHOOTING.md](TROUBLESHOOTING.md)** - Common issues and solutions
- **Corporate IT Support** - For environment-specific issues or infrastructure problems
- **SQL Server Configuration** - Verify your database server is properly configured and accessible

### Database Setup

1. **Important:** Ensure EF Core tools version matches your project packages. This project uses EF Core 8.0.22, so you need EF tools 8.0.x:

   ```powershell
   # Check current EF tools version
   dotnet ef --version
   
   # If not version 8.0.x, uninstall and reinstall
   dotnet tool uninstall --global dotnet-ef
   dotnet tool install --global dotnet-ef --version 8.0.22
   ```

2. Create and apply the initial migration:
   ```powershell
   dotnet ef migrations add InitialCreate
   dotnet ef database update
   ```

3. Run the application - it will automatically seed the database on first run:
   ```powershell
   dotnet run
   ```

**Alternative:** Run the application without migrations - it will automatically create and seed the database using `EnsureCreatedAsync()`:
   ```powershell
   dotnet run
   ```

### Database Seeding

The application automatically seeds the database with fake data on startup if the database is empty. This behavior can be controlled via `appsettings.json`:

```json
"SeedSettings": {
  "EnableSeeding": true,
  "CustomerCount": 50,
  "MinInvoicesPerCustomer": 1,
  "MaxInvoicesPerCustomer": 5,
  "MinPhoneNumbersPerCustomer": 1,
  "MaxPhoneNumbersPerCustomer": 3
}
```

**Configuration Options:**
- `EnableSeeding`: Set to `false` to disable automatic seeding
- `CustomerCount`: Number of customers to generate
- `MinInvoicesPerCustomer`: Minimum invoices per customer
- `MaxInvoicesPerCustomer`: Maximum invoices per customer
- `MinPhoneNumbersPerCustomer`: Minimum phone numbers per customer
- `MaxPhoneNumbersPerCustomer`: Maximum phone numbers per customer

The seeding process:
- Only runs if the database is empty (no existing customers)
- Generates realistic UK company names and email addresses
- Creates invoices with amounts between GBP 10-5000 dated within the past 2 years
- Generates UK-formatted phone numbers with valid types
- **All IDs are automatically generated by the database**

### Running the Application

```powershell
dotnet run
```

Or from Visual Studio: Press **F5** or click the **Start** button.

The API will be available at:
- HTTPS: https://localhost:7xxx
- HTTP: http://localhost:5xxx
- Swagger UI: https://localhost:7xxx/swagger

### Additional Commands

**Build the project:**
```powershell
dotnet build
```

**Restore NuGet packages:**
```powershell
dotnet restore
```

**Clean build artifacts:**
```powershell
dotnet clean
```

**Run with specific environment:**
```powershell
$env:ASPNETCORE_ENVIRONMENT="Development"
dotnet run
```

**Entity Framework Tools:**
```powershell
# Install/Update EF Core tools globally
dotnet tool install --global dotnet-ef
dotnet tool update --global dotnet-ef

# Check EF Core version
dotnet ef --version

# List all migrations
dotnet ef migrations list

# Remove last migration
dotnet ef migrations remove

# Generate SQL script from migrations
dotnet ef migrations script -o migration.sql

# Update to specific migration
dotnet ef database update <MigrationName>

# Drop the database
dotnet ef database drop
```

## API Endpoints

### Customers
- `GET /api/customers` - Get all customers
- `GET /api/customers/{id}` - Get customer by ID
- `GET /api/customers/email/{email}` - Get customer by email
- `POST /api/customers` - Create new customer (ID auto-generated, returned in response)
- `PUT /api/customers/{id}` - Update customer
- `DELETE /api/customers/{id}` - Delete customer

**Example POST Request:**
```json
{
  "name": "Acme Corporation",
  "email": "contact@acme.com"
}
```

**Example POST Response (201 Created):**
```json
{
  "id": 123,
  "name": "Acme Corporation",
  "email": "contact@acme.com",
  "balance": 0,
  "invoices": null,
  "phoneNumbers": null
}
```

### Invoices
- `GET /api/invoices` - Get all invoices
- `GET /api/invoices/{id}` - Get invoice by ID
- `GET /api/invoices/customer/{customerId}` - Get invoices by customer
- `GET /api/invoices/number/{invoiceNumber}` - Get invoice by number
- `POST /api/invoices` - Create new invoice (ID auto-generated, returned in response)
- `PUT /api/invoices/{id}` - Update invoice
- `DELETE /api/invoices/{id}` - Delete invoice

**Example POST Request:**
```json
{
  "invoiceNumber": "INV-20240001",
  "customerId": 123,
  "invoiceDate": "2024-01-15T00:00:00",
  "amount": 1250.50
}
```

**Example POST Response (201 Created):**
```json
{
  "id": 456,
  "invoiceNumber": "INV-20240001",
  "customerId": 123,
  "invoiceDate": "2024-01-15T00:00:00",
  "amount": 1250.50
}
```

### Telephone Numbers
- `GET /api/telephonenumbers` - Get all telephone numbers
- `GET /api/telephonenumbers/{id}` - Get telephone number by ID
- `GET /api/telephonenumbers/customer/{customerId}` - Get telephone numbers by customer
- `POST /api/telephonenumbers` - Create new telephone number (ID auto-generated, returned in response)
- `PUT /api/telephonenumbers/{id}` - Update telephone number
- `DELETE /api/telephonenumbers/{id}` - Delete telephone number

**Example POST Request:**
```json
{
  "customerId": 123,
  "type": "Mobile",
  "number": "+44 7700 900123"
}
```

**Example POST Response (201 Created):**
```json
{
  "id": 789,
  "customerId": 123,
  "type": "Mobile",
  "number": "+44 7700 900123"
}
```

## Testing with PowerShell

You can test the API endpoints using PowerShell's `Invoke-RestMethod`:

```powershell
# Get all customers
Invoke-RestMethod -Uri "https://localhost:7xxx/api/customers" -Method GET

# Create a new customer
$body = @{
    name = "Test Company"
    email = "test@example.com"
} | ConvertTo-Json

Invoke-RestMethod -Uri "https://localhost:7xxx/api/customers" -Method POST -Body $body -ContentType "application/json"

# Get customer by ID
Invoke-RestMethod -Uri "https://localhost:7xxx/api/customers/1" -Method GET
```

## Technologies Used

- .NET 8
- Entity Framework Core 8.0
- SQL Server
- Swashbuckle (Swagger/OpenAPI)
- Bogus (Fake data generation)
- Repository Pattern
- DTO Pattern
- Database-Generated Identity Columns
